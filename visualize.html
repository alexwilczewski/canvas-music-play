<!doctype html>
<html>
<head>

<title>Visualize Me</title>

<script type="text/javascript">
function AudioManager() {
  this.context = new webkitAudioContext();
  this.analyser = this.context.createAnalyser();

  this.audioObject;
  this.source;
  this.hookedUp = true;
}
AudioManager.prototype.construct = function() {
  this.audioObject = document.createElement("audio");
  this.audioObject.id = "myAudio";
  // audio.src = "/audio3.mp3";
  document.getElementsByTagName("body")[0].insertBefore(this.audioObject);
};
AudioManager.prototype.destruct = function() {

};
AudioManager.prototype.changeSrc = function(src) {
  this.audioObject.src = src;
  this.hookedUp = true;
};
AudioManager.prototype.hookup = function() {
  this.hookedUp = false;

  this.source = this.context.createMediaElementSource(this.audioObject);
  this.source.connect(this.analyser);
  this.analyser.connect(this.context.destination);
};
AudioManager.prototype.teardown = function() {
  // Disconnect those things
};
AudioManager.prototype.play = function() {
  if(this.hookedUp) {
    this.hookup();
  }

  this.audioObject.play();
};
AudioManager.prototype.pause = function() {
  this.audioObject.pause();
};
AudioManager.prototype.stop = function() {
  this.audioObject.pause();
  this.audioObject.currentTime = 0;
};
AudioManager.prototype.getFreqData = function() {
  var freqByteData = new Uint8Array(this.analyser.frequencyBinCount);
  this.analyser.getByteFrequencyData(freqByteData);
  return freqByteData;
};

var MAX_BAR = 500;

window.addEventListener("load", function() {
  var audioManager = new AudioManager();
  audioManager.construct();
  audioManager.changeSrc("/audio3.mp3");

  

  var canvas = document.getElementById("canvas");
  var ctx = canvas.getContext('2d');


  var body = document.getElementsByTagName("body")[0];

  function rafCallback(time) {
    window.requestAnimationFrame(rafCallback);

    ctx.clearRect(0, 0, 500, 500);

    var freqByteData = audioManager.getFreqData();

    var full_step = Math.floor(freqByteData.length / MAX_BAR);

    for (var j = 0; j < MAX_BAR; j++) {
      var size = 0;
      for(var i = 0; i<full_step; i++) {
        size += freqByteData[j*full_step+i];
      }

      
      var mag = size/full_step;
      drawBar(ctx, 0, j*2, mag, 1);
      
    }
  }

  audioManager.audioObject.addEventListener("loadstart", function() {
    audioManager.play();
    rafCallback();
  });
});






function drawBar(ctx, x, y, width, height) {
  ctx.fillStyle = "#990000";
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x+width, y);
  ctx.lineTo(x+width, y+height);
  ctx.lineTo(x, y+height);
  ctx.lineTo(x, y);
  ctx.fill();
}

</script>
</head>

<body>
  <canvas id="canvas" width="320" height="500"></canvas>
</body>
</html>